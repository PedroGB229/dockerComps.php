<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
.user-menu .dropdown-menu { width: 280px; }
.user-header { height: 170px; }
.user-image { object-fit: cover; }
body.modal-open { overflow: auto !important; padding-right: 0 !important; }

#toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
}
</style>
</head>

<body class="bg-light">

<div id="toast-container"></div>

<nav class="navbar bg-white border-bottom shadow-sm px-3">
    <span class="navbar-brand fw-bold">Sistema</span>

    <ul class="navbar-nav ms-auto">
        <li class="nav-item dropdown user-menu">
            <a class="nav-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown">
                <img id="nav-user-img" class="rounded-circle shadow-sm" width="32" height="32">
                <span id="nav-user-name" class="ms-2 fw-semibold"></span>
            </a>

            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                <li class="user-header bg-primary text-white text-center p-3 rounded-top">
                    <img id="dropdown-user-img" class="rounded-circle shadow mb-2" width="80">
                    <p id="dropdown-user-info" class="mb-0 fw-bold"></p>
                </li>

                <li>
                    <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#modalNovoUsuario">
                        <i class="bi bi-person-plus me-2 text-success"></i>
                        Novo Usu치rio
                    </a>
                </li>

                <li><hr class="dropdown-divider"></li>

                <li>
                    <a class="dropdown-item text-danger fw-bold" onclick="UserService.logout()">
                        <i class="bi bi-box-arrow-right me-2"></i>
                        Sair
                    </a>
                </li>
            </ul>
        </li>
    </ul>
</nav>

<!-- MODAL NOVO USU츼RIO -->
<div class="modal fade" id="modalNovoUsuario">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">Cadastrar Usu치rio</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form id="formCadastro">
                <div class="modal-body text-center">
                    <img id="previewAvatar" width="90" class="rounded-circle shadow mb-3">
                    <input type="text" id="nomeUsuario" class="form-control" placeholder="Nome completo" required>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-success w-100">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ===== UTILIDADES =====
function mostrarAviso(msg, cor="primary") {
    const c = document.getElementById("toast-container");
    const t = document.createElement("div");
    t.className = `alert alert-${cor} shadow`;
    t.textContent = msg;
    c.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

function limparModal() {
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';

    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
}

function corPorNome(nome) {
    const cores = ["0d6efd","198754","dc3545","6f42c1","fd7e14"];
    let hash = 0;
    for (let i = 0; i < nome.length; i++) {
        hash = nome.charCodeAt(i) + ((hash << 5) - hash);
    }
    return cores[Math.abs(hash) % cores.length];
}

function gerarAvatar(nome) {
    const estilos = ["initials", "pixel-art", "bottts", "adventurer"];
    const estilo = estilos[nome.length % estilos.length];
    const cor = corPorNome(nome);

    return `https://api.dicebear.com/9.x/${estilo}/svg?seed=${encodeURIComponent(nome)}&backgroundColor=${cor}`;
}

// ===== SERVI칂O DE USU츼RIO =====
const UserService = {
    getUsuarios() {
        return JSON.parse(localStorage.getItem("usuarios")) || [];
    },

    salvarUsuario(usuario) {
        const usuarios = this.getUsuarios();
        usuarios.push(usuario);
        localStorage.setItem("usuarios", JSON.stringify(usuarios));
        localStorage.setItem("user_session", JSON.stringify(usuario));
    },

    getUsuarioAtivo() {
        return JSON.parse(localStorage.getItem("user_session"));
    },

    logout() {
        localStorage.removeItem("user_session");
        location.reload();
    }
};

// ===== UI =====
function aplicarDadosUsuario(user) {
    document.getElementById("nav-user-name").textContent = user.nome.split(" ")[0];
    document.getElementById("nav-user-img").src = user.img;
    document.getElementById("dropdown-user-img").src = user.img;
    document.getElementById("dropdown-user-info").innerHTML = `
        ${user.nome}
        <small class="d-block fw-light">${user.cargo}</small>
    `;
}

// ===== EVENTOS =====
const nomeInput = document.getElementById("nomeUsuario");
const previewAvatar = document.getElementById("previewAvatar");

nomeInput.addEventListener("input", () => {
    previewAvatar.src = gerarAvatar(nomeInput.value || "Usu치rio");
});

document.getElementById("formCadastro").addEventListener("submit", e => {
    e.preventDefault();

    const nome = nomeInput.value.trim();
    if (!nome) return;

    const usuario = {
        nome,
        cargo: "Usu치rio",
        img: gerarAvatar(nome)
    };

    UserService.salvarUsuario(usuario);
    aplicarDadosUsuario(usuario);

    mostrarAviso("Usu치rio cadastrado com sucesso!", "success");

    const modalEl = document.getElementById("modalNovoUsuario");
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();

    setTimeout(limparModal, 150); // 游댠 LINHA MAIS IMPORTANTE
});


// ===== INIT =====
window.onload = () => {
    const user = UserService.getUsuarioAtivo();
    if (user) {
        aplicarDadosUsuario(user);
    } else {
        const visitante = {
            nome: "Visitante",
            cargo: "Visitante",
            img: gerarAvatar("Visitante")
        };
        aplicarDadosUsuario(visitante);
    }

    previewAvatar.src = gerarAvatar("Usu치rio");
};
</script>

</body>
</html>
